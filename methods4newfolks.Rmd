---
title: "Modeling policy interventions"
subtitle: "with applications in terraforming"
author: "Kyle D Hart"
date: "18 November 2020"
output:
  ioslides_presentation:
    css: gfx/styles.css
    logo: gfx/logo_gray.png
    toc: yes
widescreen: yes
  
---

```{r setup, include=FALSE}
library(trahelyk)
library(xkcd)
library(ggdag)
knitr::opts_chunk$set(echo = FALSE,
                      warning=FALSE,
                      fig.width=10)
```

# Intro

## Agenda
* Intro
* Talk about some stuff
* Outro

## Introductions
* Name
* Background in econometrics vs biostats
* Where you were before CHSE
* Favorite movie

# Panel data

## Rando example
```{r}
intervention <- 274
set.seed(3894)
ts_basic <- tibble(day = 150:365) %>%
  mutate(post = day > intervention,
         y = 500 + (0.1 * day) + (-80 * post) + (-0.3 * post * (day-274)) + rnorm(n=nrow(.), mean=0, sd=50))

# summary(lm(y ~ day*post, data=ts_ba))

(p <- ggplot(data=ts_basic,
       aes(x=day, y=y)) +
  geom_smooth(data=ts_basic %>% filter(day < intervention),
              method="lm", formula="y ~ x", se=FALSE, alpha=0.4) +
  geom_smooth(data=ts_basic %>% filter(day > intervention),
              method="lm", formula="y ~ x", se=FALSE, alpha=0.4) +
  geom_point(alpha=0.3) +
  annotate(geom="text",
           # x = intervention, 
           x = 274,
           y = min(ts_basic$y) + 5, 
           label=" Shock",
           hjust=0, 
           family = "xkcd") +
  geom_vline(xintercept = 274) +
  scale_y_continuous(name="Outcome") +
  xkcdaxis(range(ts_basic$day), range(ts_basic$y)))

```

## Impact of a policy intervention

```{r}
p +
  annotate(geom="text", family="xkcd",
             x=274, y=490,
             label = " Level ",
             color = "red", lwd=9,
             hjust=1) +
  annotate(geom="text", family="xkcd",
             x=318, y=455,
             label = "Slope",
             color = "red", lwd=9,
             hjust=0.5,
           angle = -9) 
```

## Estimate, estimator, and estimand

* I tried to frame this similar to https://diff.healthpolicydatascience.org/. You should read that if you haven't already. 
* For each appraoch, think about the estimand you are trying to estimate.

## Notation

$$
\begin{align}
  Y(t) ~~&|~~  \mbox{Observed outcome at time } t \\
  D = 0 ~~&|~~ \mbox{Control} \\
  D = 1 ~~&|~~ \mbox{Treated} \\
  t = 1, \ldots, T_0 ~~&|~~ \mbox{Pre-intervention times} \\
  t = T_0 + 1, \ldots, T ~~&|~~ \mbox{Post-intervention times} \\
  Y^d(t) ~~&|~~ \mbox{Potential outcome with treatment } D=d \mbox{ at time } t
\end{align}
$$
<!-- X ~~&|~~ \mbox{Observed covariates} \\ -->
<!--   U ~~&|~~ \mbox{Unobserved covariates} -->

## Counterfactual framework

**Two parallel universes** ![](gfx/parallel.jpg){width=30%, height=30%, align=right}

* one where the intervention occurred 
* one where the intervention did not occur

<br><br>

Policy effect = difference between the outcomes in those two universes

## Average treatment effect on the treated (ATT)

**Estimand:**
$$
ATT = E[Y^1 - Y^0 | D = 1]
$$

**Estimator:**

Depends on the research question and on what data are available


# Application: Terraforming LV-426

## Hadley's Hope
![LV-426](gfx/acheron_full.jpg)

## Building Better Worlds | The Weyland-Yutani workplace safety program

* Terraforming workers at the Hadley's Hope colony on exomoon LV-426 sometimes experience serious workplace injuries. 
* These injuries can lead to expensive claims against the company and delays in the colonization schedule. 
* On October 1, 2176, the Weyland-Yutani corporation implemented a safety program that included a mandatory 3-hour training workshop and disciplinary measures for workers who don't follow safety protocols. 

## Broad research question

> What effect does this policy intervention have on monthly operating costs?  

## Some strategies

Increasing level of sophistication:

* Pre/post test
* Interrupted time series (ITS)
* Comparative ITS
* Difference in differences

## Data-generating function
This slide needs work. 

The point is that the true ATE should be -25. 

hh <- tibble(Date = rep(seq(ymd("2174-01-01"), ymd("2178-12-31"), by="month"), times=2),
             time = rep(1:60, times=2),
             weather_index = runif(n=120, min=0, max=10)) %>%
  mutate(colony = rep(c("Hadley's Hope", "Fiorina 161"), each=nrow(.)/2),
         post = time > intervention,
         y = 500 + (100 * as.numeric(colony=="Hadley's Hope")) + (3 * time) + 
           (-25 * as.numeric((colony=="Hadley's Hope" & post))) + 
           (-2 * post * as.numeric(colony=="Hadley's Hope") * (time-31)) + 
           (5 * weather_index) +
           rnorm(n=nrow(.), mean=0, sd=20))

$$
y_{it} = 500 + 3 \times \mbox{MONTH} + \\
  100 \times \mathbb{I}(\mbox{TREAT} = 1) + \\
  -25 \times \mathbb{I}(\mbox{TREAT} = 1 \cap \mbox{MONTH} > 31) + \\
  -2 \times \mathbb{I}(\mbox{TREAT} = 1 \cap \mbox{MONTH} > 31) \times (\mbox{MONTH} - 31)\\
  5 \times \mbox{WEATHER} +
  \varepsilon
  
$$

```{r}
intervention <- 31
set.seed(9583)
colonies <- tibble(colony = rep(c("Hadley's Hope",
                                  "Relitor",
                                  "Arceon",
                                  "Articus",
                                  "Arcturus",
                                  "Fiorina 161",
                                  "Argos",
                                  "Atlas",
                                  "Crysalis",
                                  "Cyrus"), each = 60),
                   time = rep(1:60, times=10),
                   t = rep(-30:29, times=10),
                   colony_effect = rep(rnorm(n=10, mean=0, sd=10), each=60)) %>%
  mutate(weather_index = runif(n=nrow(.), min=0, max=10),
         treat = rep(c(1, 0), each=60*5),
         post = as.numeric(time > intervention)) %>% 
  mutate(y = 500 + (3 * time) + 
           (20 * treat) + 
           (-40 * treat * post) + 
           (-1 * treat * post * (time-intervention)) + 
           (5 * weather_index) +
           colony_effect + 
           rnorm(n=nrow(.), mean=0, sd=20))

hh <- colonies %>% filter(colony=="Hadley's Hope")

hhf <- colonies %>% filter(colony %in% c("Hadley's Hope", "Fiorina 161")) %>%
  mutate(colony_tx = factor(treat, levels=c(0, 1),
                            labels=c("Fiorina 161 --comparison--",
                                     "Hadley's Hope --intervention--")))

```

# Comparing pre/post means

## Operating costs over time

```{r}
(hh_proto <- ggplot(data=hh,
                   aes(x=time, y=y)) +
  geom_point(alpha=0.5, size=2.5) +
  annotate(geom="text",
           x = 0,
           y = min(hh$y) - 8, 
           label=" Start of terraforming operation",
           hjust=0, 
           family = "xkcd") +
  annotate(geom="text",
           x = intervention,
           y = min(hh$y) - 8, 
           label=" Month 31: Implement safety program",
           hjust=0, 
           family = "xkcd") +
  geom_vline(xintercept = 31) +
  scale_y_continuous(name="Monthly operating costs, millions") +
  scale_x_continuous(breaks=seq(0, 60, 10)) +
  xkcdaxis(range(hh$time), range(hh$y)) +
  theme(legend.title = element_blank(),
        legend.position = "bottom"))

```


## Compare means

```{r}
xbar_pre <- mean(hh$y[hh$post==0])
xbar_post <- mean(hh$y[hh$post==1])
delta <- round(xbar_post - xbar_pre)

hh_proto + 
  xkcdline(data = tibble(x1 = c(1, 32),
                         x2 = c(30, 59),
                         y1 = c(xbar_pre, xbar_post),
                         post = factor(c("Pre", "Post"))),
           aes(x=x1, xend=x2,
               y=y1, yend=y1,
               colour = post),
           mask=FALSE) +
  annotate(geom="text",
           x = 15, y = xbar_pre + 11,
           label = paste("bar(x)[pre] ==", rnd(xbar_pre, 0)),
           parse=TRUE,
           family="xkcd", size=10, color="#00BFC4") + 
  annotate(geom="text",
           x = 45, y = xbar_post + 11,
           label = paste("bar(x)[post] ==", rnd(xbar_post, 0)),
           parse=TRUE,
           family="xkcd", size=10, color="#F8766D") + 
  xkcdline(data = tibble(x = 31.5, xend = 31.5,
                         y = round(xbar_pre),
                         yend = round(xbar_post)),
           aes(x=x, xend=xend,
               y=y, yend=yend),
           mask=FALSE) +
  xkcdline(data = tibble(x = 31.5 - 0.5, xend = 31.5 + 0.5,
                         y = round(xbar_pre),
                         yend = round(xbar_pre)),
           aes(x=x, xend=xend,
               y=y, yend=yend),
           mask=FALSE) +
  xkcdline(data = tibble(x = 31.5 - 0.5, xend = 31.5 + 0.5,
                         y = round(xbar_post),
                         yend = round(xbar_post)),
           aes(x=x, xend=xend,
               y=y, yend=yend),
           mask=FALSE) +
  xkcdline(data = tibble(x = 31.5, xend = 33.5,
                         y = xbar_pre + (delta/2),
                         yend = xbar_pre + (delta/2)),
           aes(x=x, xend=xend,
               y=y, yend=yend),
           mask=FALSE) +
    annotate(geom="text",
           x = 34,
           y = xbar_pre + (delta/2),
           label= paste("delta ==", delta),
           parse=TRUE,
           hjust=0, size=10,
           family = "xkcd") +
  scale_color_discrete(c("red", "blue")) +
  theme(legend.title = element_blank(),
        legend.position = "none") 
```

## ATT

$$
\begin{align}
ATT =& E[Y^1 - Y^0 | D = 1] \\
    =& E[Y^1 | D = 1] - E[Y^0 | D = 1]
\end{align}
$$
$E[Y^0 | D = 1]$ is in the other universe, so assume 

$$
\begin{align}
E[Y^0 | D = 1] &= E[Y^0(t > T_0) | D = 1] \\
&= E[Y^1(t \le T_0) | D = 1]
\end{align}
$$

## ATT

Then 

$$
\begin{align}
ATT &= E[Y^1 - Y^0 | D = 1] \\
 &= E[Y^1 | D = 1] - E[Y^0 | D = 1] \\
 &= E[Y^1(t > T_0) | D = 1] - E[Y^0(t > T_0) | D = 1] \\
 &= E[Y^1(t > T_0) | D = 1] - E[Y^1(t < T_0) | D = 1] \\
 & = \bar{X}_{t > T_0} - \bar{X}_{t < T_0}
\end{align}
$$

## t-test
$$
t = \frac{\bar{X}_{post} - \bar{X}_{pre}}{s \sqrt{\frac{2}{n}}}
$$

```{r echo=TRUE, results='hold'}
mean(hh$y[hh$post==1]) - mean(hh$y[hh$post==0])
with(hh, t.test(y ~ post))
```

## OLS

Similarly, 
$$
Y = \beta_0 + \beta_1 \mbox{POST} + \mathbf{\beta_x X} + \varepsilon
$$

```{r echo=TRUE}
lm_prepost <- lm(y ~ post + weather_index,
           data=hh)
```

```{r}
tidy(lm_prepost) %>% 
  mutate(p.value = fmt.pval(p.value, include.p=FALSE))
```

## Comparing pre/post means

**Assumptions:**

* Outcomes would stay the same over time in the absence of the intervention
* No unmeasured confounding

**Accounts for:**

* Baseline value for outcomes

**Does not account for:**

* Outcome was already getting better or worse
* Anything that changed outcomes unrelated to the intervention

```{r fig.width=3, fig.height=3}
ggdag(tidy_dagitty(dagify(
                          y ~ x, 
                          y ~ z,
                          x ~ z,
                          exposure = "x",
                          outcome = "y"))) +
  theme_dag()

```

# Interrupted time series

## Operating costs over time

```{r}
hh_proto
```

## Change in level

```{r}
lm_its <- lm(y ~ time + post,
             data = hh)
hh_proto +
  geom_smooth(data = hh %>% filter(post==0) %>%
                mutate(y = predict(lm_its, 
                                   newdata=.)),
              method="lm", formula="y ~ x") +
  geom_smooth(data = tibble(post = rep(0, 29),
                            time = 32:60) %>%
                mutate(y = predict(lm_its, 
                                   newdata=.)),
              method="lm", formula="y ~ x",
              lty=2) + 
  geom_smooth(data = hh %>% filter(post==1) %>%
                mutate(y = predict(lm_its, 
                                   newdata=.)),
              method="lm", formula="y ~ x")

```

## Change in level

$$
\begin{align}
\mbox{Compare means:} ~~|&~~ Y = \beta_0 + \beta_1 POST + \varepsilon \\
\mbox{ITS (level):} ~~|&~~ Y_{t} = \beta_0 + \beta_1 \mbox{TIME} + \beta_2 \mbox{POST} + \varepsilon_t\\
\end{align}
$$

$$
\begin{align}
ATT &= E[Y^1 - Y^0 | D = 1] \\
 &= E[Y^1 | D = 1] - E[Y^0 | D = 1] \\
 & = \beta_2
\end{align}
$$

## Linear model

```{r echo=TRUE}
lm_its <- lm(y ~ t + post,
             data = hh)
```

```{r}
(coefs_its <- tidy(lm_its) %>% 
  mutate(p.value = fmt.pval(p.value, include.p=FALSE)))

```

## Change in level and slope

```{r}
lm_its2 <- lm(y ~ time*post,
             data = hh)
hh_proto +
  # Predicted pre-intervention
  geom_smooth(data = hh %>% filter(post==0) %>%
                mutate(y = predict(lm_its2, 
                                   newdata=.)),
              method="lm", formula="y ~ x") +
  # Predicted post-intervention counterfactual
  geom_smooth(data = tibble(post = rep(0, 29),
                            time = 32:60) %>%
                mutate(y = predict(lm_its2, 
                                   newdata=.)),
              method="lm", formula="y ~ x",
              lty=2) + 
  # Predicted post-intervention observed
  geom_smooth(data = hh %>% filter(post==1) %>%
                mutate(y = predict(lm_its2, 
                                   newdata=.)),
              method="lm", formula="y ~ x")

```

## Change in level and slope | Linear model

$$
\begin{align}
\mbox{Compare means:} ~~|&~~ Y = \beta_0 + \beta_1 POST + \varepsilon \\
\mbox{ITS (level):} ~~|&~~ Y_{t} = \beta_0 + \beta_1 \mbox{TIME} + \beta_2 \mbox{POST} + \varepsilon_t\\
\mbox{ITS (level & slope):} ~~|&~~ Y_{t} = \beta_0 + \beta_1 \mbox{TIME} + \beta_2 \mbox{POST} + \beta_3 \mbox{TIME} \times \mbox{POST} + \varepsilon_t\\
\end{align}
$$

## ATT

$$
Y_{t} = \beta_0 + \beta_1 \mbox{TIME} + \beta_2 \mbox{POST} + \beta_3 \mbox{TIME} \times \mbox{POST} + \varepsilon_t
$$

So for any $t \in T \ge T_0$,

$$
\begin{align}
ATT(t) &= E[Y^1(t) - Y^0(t) | D = 1] \\
 &= E[Y^1(t) | D = 1] - E[Y^0(t) | D = 1] \\
 & = \beta_2 + (\beta_3 \times t)
\end{align}
$$

## Change in level and slope | Linear model
```{r echo=TRUE}
lm_its2 <- lm(y ~ t*post,
             data = hh)
```

```{r}
(coefs_its2 <- tidy(lm_its2) %>% 
  mutate(p.value = fmt.pval(p.value, include.p=FALSE)))
```

# Comparative methods

## Fiorina 161
![Fiorina 161, Outer Veil](gfx/fiorina161.jpg){width=100%, height=90%}

## Fiorina 161 and Hadley's Hope
```{r}
(hhf_proto <- ggplot(data=hhf,
       aes(x=time, y=y)) +
  geom_point(aes(group=colony, color=colony),
             alpha=0.4, size=2.5) +
    annotate(geom="text",
           x = 0,
           y = min(hhf$y) - 9, 
           label=" Start of terraforming operation",
           hjust=0, 
           family = "xkcd") +
    annotate(geom="text",
           x = intervention,
           y = min(hhf$y) - 9, 
           label=" Month 31: Implement safety program",
           hjust=0, 
           family = "xkcd") +
  geom_vline(xintercept = 31) +
  scale_y_continuous(name="Monthly operating costs, millions") +
  scale_x_continuous(breaks=seq(0, 60, 10)) +
  scale_color_discrete(c("red", "blue")) + 
  xkcdaxis(range(hhf$time), range(hhf$y)) +
  theme(legend.title = element_blank(),
        legend.box.background = element_rect(colour = "black"),
        legend.position = c(0.2, 0.8)))
```

## Two-group post-mean comparison

```{r}
xbar_0 <- mean(hhf$y[hhf$treat==1 & hhf$post==0])
xbar_1 <- mean(hhf$y[hhf$treat==1 & hhf$post==1])
delta <- round(xbar_1) - round(xbar_0)

hhf_proto +
  xkcdline(data = tibble(x1 = c(32),
                         x2 = c(59),
                         y1 = c(xbar_1),
                         post = factor(c("Hadley's Hope"))),
           aes(x=x1, xend=x2,
               y=y1, yend=y1,
               colour = post),
           mask=FALSE) +
  annotate(geom="text",
           x = 15, y = xbar_0 + 12,
           label = paste("bar(x)['Hadleys NOPE'] ==", rnd(xbar_0, 0)),
           parse=TRUE,
           family="xkcd", size=10, color="black") + 
  annotate(geom="text",
           x = 45, y = xbar_1 - 12,
           label = paste("bar(x)['Hadleys Hope'] ==", rnd(xbar_1, 0)),
           parse=TRUE,
           family="xkcd", size=10, color="#00BFC4") + 
  xkcdline(data = tibble(x = 2 - 0.5, xend = 30 + 0.5,
                         y = round(xbar_0)-2,
                         yend = round(xbar_0)-2),
           aes(x=x, xend=xend,
               y=y, yend=yend),
           mask=FALSE)

```

## Two-group post-mean comparison

```{r}
xbar_0 <- mean(hhf$y[hhf$treat==0 & hhf$post==1])
xbar_1 <- mean(hhf$y[hhf$treat==1 & hhf$post==1])
delta <- round(xbar_1) - round(xbar_0)

hhf_proto +
  xkcdline(data = tibble(x1 = c(32, 32),
                         x2 = c(59, 59),
                         y1 = c(xbar_0, xbar_1),
                         post = factor(c("Fiorina 161", "Hadley's Hope"))),
           aes(x=x1, xend=x2,
               y=y1, yend=y1,
               colour = post),
           mask=FALSE) +
  annotate(geom="text",
           x = 45, y = xbar_0 + 12,
           label = paste("bar(x)['Fiorina 161'] ==", rnd(xbar_0, 0)),
           parse=TRUE,
           family="xkcd", size=10, color="#F8766D") + 
  annotate(geom="text",
           x = 45, y = xbar_1 - 12,
           label = paste("bar(x)['Hadleys Hope'] ==", rnd(xbar_1, 0)),
           parse=TRUE,
           family="xkcd", size=10, color="#00BFC4") + 
  xkcdline(data = tibble(x = 45.5, xend = 45.5,
                         y = round(xbar_0) - 2,
                         yend = round(xbar_1) + 2),
           aes(x=x, xend=xend,
               y=y, yend=yend),
           mask=FALSE) +
  xkcdline(data = tibble(x = 45.5 - 0.5, xend = 45.5 + 0.5,
                         y = round(xbar_0)-2,
                         yend = round(xbar_0)-2),
           aes(x=x, xend=xend,
               y=y, yend=yend),
           mask=FALSE) +
  xkcdline(data = tibble(x = 45.5 - 0.5, xend = 45.5 + 0.5,
                         y = round(xbar_1)+2,
                         yend = round(xbar_1)+2),
           aes(x=x, xend=xend,
               y=y, yend=yend),
           mask=FALSE) +
    annotate(geom="text",
           x = 46,
           y = xbar_0 + (delta/2),
           label= paste("delta ==", delta),
           parse=TRUE,
           hjust=0, size=10,
           family = "xkcd") 

```

## Two-group post-mean comparison

$$
t = \frac{\bar{X}_{test} - \bar{X}_{comparison}}{s \sqrt{\frac{2}{n}}}
$$

```{r echo=TRUE}
mean(hhf$y[hhf$treat==1]) - mean(hhf$y[hhf$treat==0])
with(hhf, t.test(y ~ post))
```

## Two-group post-mean comparison

$$
Y = \beta_0 + \beta_1 \mbox{TREAT} + \mathbf{\beta_x X} + \varepsilon
$$

```{r echo=TRUE}
lm_2grp <- lm(y ~ treat + weather_index,
           data=hhf %>% filter(post==1))
```

```{r}
md(tidy(lm_2grp) %>% 
  mutate(p.value = fmt.pval(p.value, include.p=FALSE)))
```

## Two-group post-mean comparison

* **Assumes** outcomes for the two groups would be the same if neither or both received the intervention

* **Accounts for** anything unrelated to the intervention that changed outcomes equally for both groups

* **Does not account for** any baseline differences in levels or slopes between the two groups or non-intervention **_shocks_** that affected only one group

# Difference in differences

## Fiorina 161 and Hadley's Hope

```{r}
lm_did <- lm(y ~ treat*post,
             data=hhf)

xbar_pre0 <- mean((hhf %>% filter(post==0 & treat==0) %>%
            mutate(y = predict(lm_did, 
                               newdata=.)) %>%
             pull(y)))

xbar_pre1 <- mean((hhf %>% filter(post==0 & treat==1) %>%
            mutate(y = predict(lm_did, 
                               newdata=.)) %>%
             pull(y)))

xbar_post0 <- mean((hhf %>% filter(post==1 & treat==0) %>%
            mutate(y = predict(lm_did, 
                               newdata=.)) %>%
             pull(y)))

xbar_post1 <- mean((hhf %>% filter(post==1 & treat==1) %>%
            mutate(y = predict(lm_did, 
                               newdata=.)) %>%
             pull(y)))

hhf_proto +
  # Predicted pre-intervention
  geom_smooth(data = hhf %>% filter(post==0) %>%
                mutate(y = predict(lm_did, 
                                   newdata=.)),
              aes(group=colony, color=colony),
              method="lm", formula="y ~ x") +
  # Predicted post-intervention
  geom_smooth(data = hhf %>% filter(post==1) %>%
                mutate(y = predict(lm_did, 
                                   newdata=.)),
              aes(group=colony, color=colony),
              method="lm", formula="y ~ x") +
  geom_line(data = tibble(x = c(31, 31.5, 31.5, 32, 31, 33, 33), 
                         y = c(xbar_pre0, xbar_pre0, xbar_post0, xbar_post0, 
                               xbar_pre1, xbar_pre1, xbar_post1),
                         colony = c(rep("Fiorina 161", 4), rep("Hadley's Hope", 3))),
           aes(x=x, 
               y=y, 
               colour = colony),
           lty=2) + 
  annotate(geom="text",
           x = 33.5, y = 600,
           label = "delta['d=0']",
           parse=TRUE,
           hjust=0,
           family="xkcd", size=10, color="#00BFC4") +
  annotate(geom="text",
           x = 32, y = 640,
           label = "delta['d=1']",
           parse=TRUE,
           hjust=0,
           family="xkcd", size=10, color="#F8766D") 
  
```

## Difference in differences

* **Assumes** longitudinal trends in the pre-intervention period are parallel between groups ### Update this language to reflect that one web site-- "Counterfactual assumption"
  - Parallel trends 
  - Common shocks


* **Accounts for** baseline differences in outcomes between the two groups and shocks unrelated to the intervention that affected both groups

* **Does not account for** Shocks unrelated to the intervention that only occurred in one group or differences between groups in the longitudinal trajectory before the intervention

## ATT

## 


## CITS 

$$
\begin{align}
  Y =& \beta_0 + \beta_1 \mbox{TIME} + \beta_2 \mbox{POST} + \beta_3 \mbox{POST} \times \mbox{TIME} + \\
     & \beta_4 \mbox{TREAT} + \beta_5 \mbox{TREAT} \times \mbox{TIME } + \\
     & \beta_6 \mbox{TREAT} \times \mbox{POST} + \\
     & \beta_7 \mbox{TREAT} \times \mbox{POST} \times \mbox{TIME} + \varepsilon_t
\end{align}
$$

where
$$
\mbox{TIME } = \mbox{ {1, ... 60}},\\
\mbox{POST } = \begin{cases}
                0 \mbox{ if TIME} \le 31, \\
                1 \mbox{ if TIME > 31}\\
              \end{cases},\\
\mbox{TREAT } = \begin{cases}
                0 \mbox{ = Fiorina 161}, \\
                1 \mbox{ = Hadley's Hope}
              \end{cases}
$$

##
```{r echo=TRUE}
lm_cits <- lm(y ~ time*post + time*treat + treat*post + I(treat * post * time),
             data = hhf)
```

```{r}
(coefs_its <- tidy(lm_cits) %>% 
  mutate(p.value = fmt.pval(p.value, include.p=FALSE)))

```

## Comparative interrupted time series

```{r eval=FALSE}
ggplot(data=hhf,
       aes(x=time, y=y)) +
  xkcdaxis(range(hhf$time), range(hhf$y)) +
  geom_vline(xintercept = intervention) +
  annotate(geom="text",
           # x = intervention, 
           x = 31,
           y = min(hh$y) + 5, 
           label=" Month 31: Implement safety program",
           hjust=0, 
           family = "xkcd") +
  geom_point(alpha=0.3, size=2.5) +
  geom_smooth(data = hh %>% filter(post==0) %>%
                mutate(y = predict(lm_its, 
                                   newdata=.)),
              method="lm", formula="y ~ x") +
  geom_smooth(data = tibble(post = rep(0, 29),
                            time = 32:60) %>%
                mutate(y = predict(lm_its, 
                                   newdata=.)),
              method="lm", formula="y ~ x",
              lty=2) + 
  geom_smooth(data = hh %>% filter(post==1) %>%
                mutate(y = predict(lm_its, 
                                   newdata=.)),
              method="lm", formula="y ~ x") + 
  scale_y_continuous(name="Monthly operating costs, millions")

```


```{r eval=FALSE}
ggplot(data=hh,
       aes(x=time, y=y)) +
  geom_smooth(data=hh %>% filter(time < intervention), 
              aes(group=colony, color=colony),
              se=FALSE,
              method="lm", formula="y ~ x") +
  geom_smooth(data=hh %>% filter(time > intervention), 
              aes(group=colony, color=colony),
              se=FALSE,
              method="lm", formula="y ~ x") +
  geom_point(aes(group=colony, color=colony), alpha=0.5) +
  annotate(geom="text",
           # x = intervention, 
           x = 274,
           y = 425, 
           label=" Safety program",
           hjust=0, 
           family = "xkcd") +
  # geom_vline(xintercept = ymd("2176-10-01")) +
  geom_vline(xintercept = 31) +
  scale_y_continuous(name="Monthly operating costs, millions") +
  xkcdaxis(range(hh$time), range(hh$y)) +
  theme(legend.title = element_blank(),
        legend.position = "bottom")

```


## Diff-in-Diff


# Some econometrics

## Fixed effects 

## Clustered standard errors 

## Marginal effects 

## Propensity scores 
 
How to speak to an economist
## Endogeneity 

## Indicators 

## Others? 

